#!/bin/bash
# Copyright (C) 1989-2023 PC2 Development Team: John Clevenger, Douglas Lane, Samir Ashoo, and Troy Boudreau.
#
# Purpose:
#   This script installs a Linux service that runs the script to create
#   the cgroup necessary for PC2 sandboxes.  The service is a one-shot service
#   that simply runs the PC2INSTALL_DIR/bin/pc2installsandbox shell script
#   After running this script, there is no need to reboot the system if the script
#   completes successfully.
#
# Arguments:
#   pc2user - Linux login name of the user that will be doing judging or auto-judging
#   pc2group - Linux group name of the user that will be doing judging or auto-judging
#     You can determine the group name of the user 'pc2user' by issuing the following command at
#     the Linux command prompt:
#       id -gn pc2user
#  The pc2user and pc2group are used to set ownership of the cgroup v2 for so the
#  judge can use the sandbox.
#
# Author: John Buck

DEBUG=
#DEBUG="echo Would"

SCRIPTNAME="$0"

# This will set basedir to the pc2 home installation folder
. `dirname $0`/pc2env

if test $# -ne 2
then
	echo Usage: $SCRIPTNAME pc2user pc2group
	echo "    pc2user - Linux login name of the user that will be doing judging or auto-judging"
	echo "    pc2group - Linux group name of the user that will be doing judging or auto-judging"
	echo "      You can determine the group name of the user 'pc2user' by issuing the following command at"
	echo "      the Linux command prompt:"
	echo "        id -gn pc2user"
	exit 4
fi
JUDGE_USER="$1"
JUDGE_GROUP="$2"
if ! getent passwd $JUDGE_USER >/dev/null 2>&1
then
	echo $SCRIPTNAME: No such user $JUDGE_USER.  The pc2user must be a valid login id.
	exit 5
fi
if ! getent group $JUDGE_GROUP >/dev/null 2>&1
then
	echo $SCRIPTNAME: No such group $JUDGE_USER.  The pc2group must be a valid group in /etc/group.
	exit 6
fi

INSTALL_SCRIPT_PATH=${basedir}/bin/pc2installsandbox
SERVICE_NAME=pc2_cgroup.service
SERVICE_FILE=${basedir}/support/system_cgroup/${SERVICE_NAME}

ServiceError()
{
	echo $SCRIPTNAME: $*
	echo $SCRIPTNAME: Service not installed.
	echo $SCRIPTNAME: For help, please refer to the '"Running in a Sandbox"' Appendix
	echo $SCRIPTNAME: in the \"PC2 Contest Administrator\'s Installation and Configuration Guide\"
}

euid=`id -u`
if test "$euid" -ne 0
then
	echo $SCRIPTNAME: This script must be run as super user
	exit 1
fi
if test ! -s ${SERVICE_FILE}
then
	ServiceError Can not find service file: ${SERVICE_FILE}
	exit 2
fi

if test ! -x ${INSTALL_SCRIPT_PATH}
then
	ServiceError The script ${INSTALL_SCRIPT_PATH} must be present and executable
	exit 3
fi

$DEBUG cp -a ${SERVICE_FILE} /etc/systemd/system
$DEBUG sed -i -e "s/%JUDGEUSER%/$JUDGE_USER/" -e "s/%JUDGEGROUP%/$JUDGE_GROUP/" /etc/systemd/system/${SERVICE_NAME}
$DEBUG systemctl enable ${SERVICE_NAME}
$DEBUG systemctl start ${SERVICE_NAME}
$DEBUG systemctl status ${SERVICE_NAME}
exit 0
